# 勝利条件追加に伴う影響レビュー

`docs/game_rules.md` に勝利条件（「*Opponent* の初期陣地に *You* のコマが移動すること」）が明記されたことを受けて、他ドキュメントと実装への影響を整理する。

## 結論（重要）

- 影響分析時点では `core` 実装が `game_rules.md` と不一致（全滅勝利）だった。
- 現在は `core` と `backend` の終局判定を「相手初期陣地への侵入」に追従済み。

## 影響範囲

### 1. ルール実装（`packages/core`）

- `applyCommand.ts` の `determineWinner` は、盤面上のコマ数を数えて勝者を判定している。
- 新しい勝利条件に合わせる場合は、以下への変更が必要。
  - 相手の**初期陣地座標**に移動した瞬間の勝利判定
  - 攻撃で敵を倒して侵入したケース（`CombatResolved` → `PieceMoved` 後）を含む判定順序
  - 複数勝利条件を併存させるか（侵入勝利のみ / 全滅勝利も残すか）の明確化

### 2. テスト（`scripts/core-unit.mjs`）

- 「正常系: 勝敗確定」テストは全滅勝利を前提にしているため、勝利条件変更後は期待値が変わる。
- 追加が必要な代表ケース:
  - 侵入で `GameFinished` が発火する
  - 侵入していない限り全滅だけでは終局しない（※侵入勝利のみ採用する場合）
  - 侵入直後に `status=Finished` となり、以降 `GAME_ALREADY_FINISHED` になる

### 3. 進捗ドキュメント（`docs/progress_report.md`）

- これまで「勝利条件未確定のため暫定」としていた記述を更新し、
  - 仕様は確定済み（`game_rules.md`）
  - 実装は未追従（ギャップあり）
  という状態に変更する必要がある。

### 4. API / 進行管理（`docs/api.md`, `packages/backend`）

- イベント型としての `GameFinished` はそのまま使える見込み。
- ただし「いつ `GameFinished` が出るか」は `core` 依存のため、ルール更新後に `backend` 側の期待シナリオ（e2e）を再確認する必要がある。

### 5. フロントエンド（`packages/frontend`）

- 勝敗表示ロジック自体は `winner/status` に依存していれば変更不要。
- 一方で、UX 上は「相手初期陣地への侵入が勝利条件」であることを UI で示す必要がある（盤面ハイライトやルール表示）。

## 推奨対応順

1. `core` の勝利判定仕様を確定（侵入勝利のみか、全滅併用か）
2. `packages/core` の判定ロジックと単体テストを更新
3. `backend` の e2e smoke で終局シナリオを更新
4. `docs/progress_report.md` と関連ドキュメントの記述を同期
