# 進捗レポート

## ロードマップ（現ゴール）

1. クリーチャーは `game_rules.md` 記載のスキルなしクリーチャー（Ameba / Goblin / Soldier）のみ対応
2. カードは実装しない
3. 2人のプレイヤーが部屋に入室できる
4. ゲームを開始できる
5. 先行後攻はランダムに決まる
6. ターンプレイヤーはクリーチャーを操作できる（ゲームルール通り）
7. ターンエンドできる
8. 相手がターンエンドしたら自分のターンが始まる
9. 勝利条件を満たすとゲーム終了する（ゲームルール通り）

---

## 全体進捗サマリ（2026-02-20更新）

- **達成済み（基盤）**: WebSocket入室、`INTENT` 受付、`EVENT/REJECT/SYNC` 配信、`seq` 順適用
- **達成済み（core主要機能）**: Creature種別/ステータス、Move検証強化、自動戦闘、死亡時補充キュー、補充召喚、勝敗確定、終局後reject
- **未達成（主にbackend/frontend）**: 2人上限の厳密制御、先後ランダム、開始プロトコル、UI体験層
- **注意点（仕様未確定の暫定実装）**:
  - 勝利条件は「相手盤面クリーチャー0体」で確定扱い（`game_rules.md` に明示定義がないため暫定）
  - 補充位置は「自陣地内の決定的先頭空きマス」（任意配置ではなく暫定）

---

## ロードマップ項目ごとの進捗

| # | ゴール | 進捗 | 現状メモ |
|---|---|---|---|
| 1 | Ameba/Goblin/Soldier のみ対応 | 達成 | `CreatureKind` / `CreatureStats` / 初期3体構成を実装済み |
| 2 | カード未実装 | 達成 | Card 型・カード処理は未実装（スコープ外） |
| 3 | 2人入室 | 部分達成 | 入室は可能。最大2人制限は未実装 |
| 4 | ゲーム開始 | 部分達成 | 接続時に即開始相当。ready/start 手順は未実装 |
| 5 | 先後ランダム | 未達成 | 初期手番は固定（`p1`） |
| 6 | ターンプレイヤーが操作可能 | 達成（カード外スコープ） | Move検証 + 自動戦闘 + 移動権制限を実装 |
| 7 | ターンエンド | 達成 | `EndTurn` でターン進行イベントを生成 |
| 8 | ターン交代 | 達成 | 手番交代 + 補充召喚フェイズ処理を実行 |
| 9 | 勝利条件で終了 | 部分達成（暫定） | 相手盤面0体で `GameFinished`。最終仕様確定は要整理 |

---

## 観点別進捗（core / backend / frontend）

### core

**完成しているもの（カード処理を除く）**
- `Move` / `EndTurn` の Intent 型
- クリーチャー種別とステータス（Ameba/Goblin/Soldier）
- Move妥当性検証（手番、所有、範囲、距離、重複、フェイズ、終局、移動権）
- 自動戦闘（移動先敵への一方攻撃）
- 死亡処理と補充待ち管理（successor cost）
- ターン進行時の補充召喚
- 勝敗確定と終局状態（`GameFinished` / `status=Finished`）
- `applyCommand` 出力イベントの `applyEvent` リプレイ一致テスト

**未完成/暫定のもの**
- カード処理（スコープ外）
- 補充位置のプレイヤー選択（現状は決定的配置）
- 勝利条件の文言確定（現状は実装上の暫定ルール）

### backend

**完成しているもの**
- Durable Object ベースの room 管理
- WebSocket メッセージ処理（`WELCOME`, `INTENT`, `EVENT`, `REJECT`, `RESYNC_REQUEST`, `SYNC`, `ADMIN`）
- `expectedTurn` とルール検証結果による reject
- `seq` 採番と event 配信
- 欠損時の `SYNC` 再同期

**未完成のもの**
- 2人上限の厳密な入室制御
- 先後ランダム決定ロジック
- ゲーム開始プロトコル（ready/start など）
- 勝敗確定/終了通知のUI向け最終整理

### frontend

**完成しているもの**
- `WELCOME` / `EVENT` / `SYNC` の受信反映 reducer
- `seq` 欠損時にイベントを適用しない安全側挙動

**未完成のもの**
- 7x7盤面UI・手札UI・開始UI などの体験層の完成
- 2人入室や開始状態の表示/制御
- 勝敗表示
- ゲームルールに沿った操作UI（現状仕様全体への追従）

---

## Coreは完了？

**結論**: **カード処理を除く現在スコープでは「ほぼ完了（実装完了）」**。  
ただし、`game_rules.md` の未確定項目（勝利条件の文言、補充配置の任意選択仕様）については、現在の実装が暫定ルールを置いているため、最終仕様確定後の微調整余地がある。

---

## 直近の優先実装

1. backend の 2人制御 + 先後ランダム + 開始フロー
2. frontend の盤面/ターン/終了状態の最低限UI
3. core の未確定仕様（勝利条件・補充配置）を仕様確定に合わせて最終調整
