# ローカル7B向け: 収束する自動開発ループ設計

## 目的

「試行運ゲー」ではなく、失敗データを使って次ループを改善し、朝にPRが残る確率を上げる。

## 収束のための設計原則

1. **同じ失敗を繰り返さない**
   - 失敗内容を構造化ログ（JSONL）へ保存する。
   - 次プロンプトに「直近3失敗の要約」を必ず注入する。
2. **検証を段階的に強化する**
   - Gate 1: 型チェック
   - Gate 2: テスト（導入後）
   - Gate 3: lint（必要に応じて）
3. **失敗回数をタスク単位で管理する**
   - 全体失敗回数ではなく、taskごとの fail count を使う。
4. **大きい変更を拒否する**
   - 変更行数上限でモデル暴走を早期停止する。

## テスト戦略（段階導入）

### Phase 0（現状）
- `typecheck` だけで回す。

### Phase 1（最優先）
- 主要ドメインロジック（`packages/core`）だけに小さなユニットテストを追加。
- 1タスク1テストの粒度で導入する。

### Phase 2
- 回帰バグは必ず「再現テスト -> 修正」の順で運用する。
- 失敗したテスト名をプロンプトへ渡す。

### Phase 3
- 変更ファイル近傍のみを対象にした高速テストセットを追加し、夜間周回数を増やす。

## verify進化方針

- `tools/verify.sh` に集約し、以下を自動判定:
  - `npm run typecheck`
  - `npm test`（script がある場合のみ）
  - `npm run lint`（script がある場合のみ）
- 実行結果は `tasks/verify_report.json` に保存。
- loop本体は verify 実装を固定せず、`verify.sh` のみ呼ぶ。

## 夜間PR自動化ロードマップ

1. **今週**
   - 失敗ログJSONL化
   - verify.sh導入
   - タスク単位 fail count
2. **次週**
   - coreユニットテスト最小セット
   - 失敗テスト名をプロンプト注入
3. **その次**
   - タスク分割器（大タスクを小タスクへ自動分解）
   - 朝にPR草案を自動生成

## 成功指標

- 同一タスクで同一エラーが3回連続する割合が下がる。
- 1夜あたり「verify成功コミット数」が増える。
- no-opコミット率が下がる。
